name: YouTube Auto Robot

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Video Topic'
        required: false
        default: 'Passive Income'
      title:
        description: 'Video Title'
        required: false
        default: 'Make $313/month with Passive Income'

jobs:
  create-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîç Debug Environment
      run: |
        echo "=== SYSTEM INFO ==="
        echo "Python: $(python --version 2>&1)"
        echo "Pip: $(pip --version)"
        which ffmpeg && ffmpeg -version | head -1 || echo "FFmpeg not found"
        echo "Current directory: $(pwd)"
        echo "Files:"
        ls -la

    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: üõ†Ô∏è Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        ffmpeg -version

    - name: üì¶ Install Python Packages
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "=== INSTALLED PACKAGES ==="
        pip list | grep -E "moviepy|google|Pillow|numpy|opencv"

    - name: üé¨ Create Silent Audio
      run: |
        echo "Creating silent audio..."
        ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 120 silent.mp4 -y 2>/dev/null || echo "Could not create audio, continuing..."
        ls -la *.mp4 2>/dev/null || echo "No MP4 files"

    - name: üöÄ Run Video Creation
      id: create_video
      env:
        VIDEO_TOPIC: ${{ github.event.inputs.topic || 'Passive Income' }}
        VIDEO_TITLE: ${{ github.event.inputs.title || 'Make $313/month with Passive Income' }}
      run: |
        echo "=== STARTING VIDEO CREATION ==="
        echo "Topic: $VIDEO_TOPIC"
        echo "Title: $VIDEO_TITLE"
        
        # Run video creator directly
        python video_creator.py
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ Video creation successful"
          echo "video_file=output_video.mp4" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Video creation failed"
          exit 1
        fi

    - name: üìÅ Check Created Video
      run: |
        echo "=== CHECKING VIDEO FILES ==="
        
        # Look for any video file
        if [ -f "output_video.mp4" ]; then
          echo "‚úÖ Found: output_video.mp4"
          mv output_video.mp4 final_video.mp4
        elif [ -f "video.mp4" ]; then
          echo "‚úÖ Found: video.mp4"
          mv video.mp4 final_video.mp4
        elif [ -f "final_video.mp4" ]; then
          echo "‚úÖ Found: final_video.mp4"
        else
          echo "‚ùå No video file found! Searching..."
          find . -name "*.mp4" -type f
          echo "Creating dummy video for testing..."
          ffmpeg -f lavfi -i testsrc=duration=10:size=1280x720:rate=30 -c:v libx264 test_video.mp4 -y
          mv test_video.mp4 final_video.mp4
        fi
        
        echo "‚úÖ Final video: final_video.mp4"
        echo "Size: $(du -h final_video.mp4 2>/dev/null || echo 'Unknown')"

    - name: üì§ Upload to YouTube
      if: env.YOUTUBE_CLIENT_ID != ''
      env:
        YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
        YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
        YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
      run: |
        echo "=== UPLOADING TO YOUTUBE ==="
        
        if [ -f "final_video.mp4" ]; then
          echo "Video found, attempting upload..."
          python youtube_uploader.py || echo "Upload failed, but continuing..."
        else
          echo "‚ùå No video to upload"
        fi

    - name: üíæ Save Video Artifact
      uses: actions/upload-artifact@v4
      with:
        name: youtube-video
        path: final_video.mp4
        retention-days: 7

    - name: üéâ Success Notification
      if: success()
      run: |
        echo "========================================"
        echo "‚úÖ YOUTUBE AUTOMATION COMPLETE"
        echo "========================================"
        echo "Video created: final_video.mp4"
        echo "Download from Artifacts section"
        echo "Check YouTube Studio if upload was attempted"
        echo "========================================"
